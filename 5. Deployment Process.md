# Deployment Process

#### 5.1 Determine the processes during deployment

###### Describe all processes that are running during deployment: Build, deploy and post-deploy phases. Explain why downtime occurs on your project

Build and deploy full steps:
1. Code and configuration validation
    - run series of checks and code validation
    - modify cluster topology (e.g. elasticsearch was added) 
    - run `composer install`
    - on syntax error in a configuration file, Git server refuses the push, see [Protective block](https://devdocs.magento.com/guides/v2.3/cloud/live/live-prot.html)
        - to disable protective block 
        ```yaml
        # .magento.app.yaml
        preflight:
           enabled: false
        ```
2. Build
    - site is not in maintenance mode
    - will not be brought down if errors or issues occur
    - cluster has not been created yet (don't try to connect to a database or assume anything was daemonized)
    - execute commands before packaging your application
    - runs hooks in the `build` section from `.magento.app.yaml`
    ```yaml
    # We run build hooks before your application has been packaged.
    build: |
        set -e
        php ./vendor/bin/ece-tools build:generate
        php ./vendor/bin/ece-tools build:transfer
       # old style
       #php ./vendor/bin/ece-tools build
    ```
    - result of the build phase is a read-only file system referred to as a slug
3. Prepare the slug
    - create an archive and put the slug in permanent storage
    - slug includes all files and folders excluding the mounts configured in `magento.app.yaml`
    ```yaml
    mounts:
        "var": "shared:files/var"
        "app/etc": "shared:files/etc"
        "pub/media": "shared:files/media"
        "pub/static": "shared:files/static"
    ```
4. Deploy slugs and cluster
    - file systems are read-only
    - mounts each service in a container (web server, Elasticsearch, RabbitMQ)
    - mounts the read-write file system (mounted on a highly available distributed storage grid)
    - configures the network so services can “see” each other (and only each other)
5. Deployment hooks
    - freeze the incoming traffic at the entry point for 60 seconds
    - puts the application in maintenance mode until deployment is complete
    - execute commands after packaging and deploying your application
    - runs hooks in the `deploy` section from `.magento.app.yaml`
    ```yaml
    # We run deploy hook after your application has been deployed and started.
    deploy: |
        php ./vendor/bin/ece-tools deploy
    ```
    - deploy script uses the values defined by configuration files in the `.magento` directory, then the script deletes the directory and its contents
6. Post-deployment: configure routing
    - creates backup (BAK) files for the app/etc/env.php and the app/etc/config.php configuration files
    - execute commands after deploying your application and after the container begins accepting connections
    - runs hooks in the `post_deploy` section from `.magento.app.yaml`
    ```yaml
    # We run post deploy hook to clean and warm the cache. Available with ECE-Tools 2002.0.10.
    post_deploy: |
        php ./vendor/bin/ece-tools post-deploy
    ```

###### What role every process/phase plays and how to impact every process
###### How Magento Cloud deploys Magento. What every script does on every deployment phase

Ece-tools [\Magento\MagentoCloud\App\Container](https://github.com/magento/ece-tools/blob/develop/src/App/Container.php#L50) initialize [\Illuminate\Container\Container](https://laravel.com/api/5.5/Illuminate/Container/Container.html) and configure all commands processes.

**Build**

`php ./vendor/bin/ece-tools build` is a proxy for calling build:generate and build:transfer commands.

```php
    public function execute(InputInterface $input, OutputInterface $output)
    {
        $this->getApplication()->find(\Magento\MagentoCloud\Command\Build\Generate::NAME)->execute($input, $output);
        $this->getApplication()->find(\Magento\MagentoCloud\Command\Build\Transfer::NAME)->execute($input, $output);
    }
```


`php ./vendor/bin/ece-tools build:generate`

> notice: Starting generate command. (magento/ece-tools version: 2002.0.17, magento/magento2-base version: 2.2.8)

- [Process\Build\PreBuild](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/PreBuild.php)
    - check `VERBOSE_COMMANDS` in `.magento.env.yaml`
    - clean `generated/code` folder
    - clean `generated/metadata` folder
    - delete flag `.static_content_deploy` file
- [Process\ValidateConfiguration](https://github.com/magento/ece-tools/tree/develop/src/Process/ValidateConfiguration.php)
    ```php
        $this->container->make(\Magento\MagentoCloud\Process\ValidateConfiguration::class, [
            'validators' => [
                ValidatorInterface::LEVEL_CRITICAL => [
                    $this->container->make(ConfigValidator\Build\ComposerFile::class),
                    $this->container->make(ConfigValidator\Build\StageConfig::class),
                    $this->container->make(ConfigValidator\Build\BuildOptionsIni::class),
                ],
                ValidatorInterface::LEVEL_WARNING => [
                    $this->container->make(ConfigValidator\Build\ConfigFileExists::class),
                    $this->container->make(ConfigValidator\Build\DeprecatedBuildOptionsIni::class),
                    $this->container->make(ConfigValidator\Build\StageConfigDeprecatedVariables::class),
                    $this->container->make(ConfigValidator\Build\ModulesExists::class),
                    $this->container->make(ConfigValidator\Build\AppropriateVersion::class),
                    $this->container->make(ConfigValidator\Build\ScdOptionsIgnorance::class),
                    $this->container->make(ConfigValidator\IdealState::class),
                ],
            ],
        ]),
    ```
    validators list: [Config/Validator/Build/](https://github.com/magento/ece-tools/tree/develop/src/Config/Validator/Build) 
- [Process\Build\RefreshModules](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/RefreshModules.php)
    - see [\Config\Module::refresh](https://github.com/magento/ece-tools/tree/develop/src/Config/Module.php)
    - enable all modules `php ./bin/magento module:enable --all --ansi --no-interaction` if `modules` not found in the `app/etc/config.php`
    - do not enable already disabled modules (if `modules` found in the `app/etc/config.php`)
- [Process\Build\ApplyPatches](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/ApplyPatches.php)
    - applying patches (`Patch\Manager::applyAll`)
        - copyStaticFile: copy `pub/static.php` => `pub/front-static.php`
        - applyComposerPatches: from [patches.json](https://github.com/magento/ece-tools/blob/develop/patches.json) file
        - applyHotFixes: `git apply` patches from `m2-hotfixes/*.patch`
- [Process\Build\MarshallFiles](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/MarshallFiles.php)
    - delete `var/cache/` directory
    - copying di.xml files for Magento version < 2.2
- [Process\Build\CopySampleData](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/CopySampleData.php)
    - copy (if exists) `vendor/magento/sample-data-media` => `/pub/media`
- [Process\Build\CompileDi](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/CompileDi.php)
    - execute `php ./bin/magento setup:di:compile {$verbosityLevel} --ansi --no-interaction`
- [Process\Build\ComposerDumpAutoload](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/ComposerDumpAutoload.php)
    - execute `composer dump-autoload -o --ansi --no-interaction`
- [Process\Build\DeployStaticContent](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/DeployStaticContent.php)
    - delete `.static_content_deploy` flag file
    - validate [Config\Validator\GlobalStage\ScdOnBuild::validate](https://github.com/magento/ece-tools/blob/develop/src/Config/Validator/GlobalStage/ScdOnBuild.php#L72)
        - check SCD_ON_DEMAND: false
        - check SKIP_SCD: false
        - validate [Config\Validator\Build\ConfigFileStructure::validate](https://github.com/magento/ece-tools/blob/develop/src/Config/Validator/Build/ConfigFileStructure.php#L63)
            - in the `app/etc/config.php` 
                - scopes/websites (count($websites) > 0)
                - scopes/stores (count($stores) > 0 )
    - if all checks valid, execute [Process\Build\DeployStaticContent\Generate](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/DeployStaticContent/Generate.php)
        - build SCD commands [StaticContent\CommandFactory::matrix](https://github.com/magento/ece-tools/blob/develop/src/StaticContent/CommandFactory.php#L98)
            - [StaticContent\CommandFactory::build](https://github.com/magento/ece-tools/blob/develop/src/StaticContent/CommandFactory.php#L131)
                - command: `php ./bin/magento setup:static-content:deploy --ansi --no-interaction`
                - add ` -f` option (for magento > 2.2)
                - add ` -s {$stratagy}` from `SCD_STRATEGY` from `.magento.env.yaml` (for magento > 2.2)
                - add verbosity level (-v, -vv, -vvv) from `VERBOSE_COMMANDS` from `.magento.env.yaml`
                - add ` --jobs {$threadCount}` threads count: `SCD_THREADS` from `.magento.env.yaml`
                - add ` --no-html-minify` by `SKIP_HTML_MINIFICATION` (default: true) from `.magento.env.yaml`
                - result example: `php ./bin/magento setup:static-content:deploy --ansi --no-interaction -f --jobs 3 --no-html-minify`
            - default command (`StaticContent\CommandFactory::create($option, array_keys($matrix))`) based on given options
                - run: StaticContent\CommandFactory::build
                - get excluded themes: `SCD_EXCLUDE_THEMES` from `.magento.env.yaml` (deprecated)
                - exclude themes from `SCD_MATRIX`
                - add unique locales [StaticContent\Build\Option::getLocales](https://github.com/magento/ece-tools/blob/develop/src/StaticContent/Build/Option.php#L124)
                    - `ADMIN_LOCALE` from (MAGENTO_CLOUD_VARIABLES) (default: en_US)
                    - `general/locale/code` from `app/etc/config.php` 
                    - `admin_user/locale/code` from `app/etc/config.php` 
                    - add `en_US`
                - result example: `php ./bin/magento setup:static-content:deploy --ansi --no-interaction -f --jobs 3 --no-html-minify --exclude-theme Magento/blank --exclude-theme Magento/luma en_US nb_NO`
            - generate commands based on `SCD_MATRIX` from `.magento.env.yaml`
                - run: StaticContent\CommandFactory::build
                - add ` --theme {$resolvedTheme}`
                - add `language` from `SCD_MATRIX` (en_US, nb_NO)
                - result example: `php ./bin/magento setup:static-content:deploy --ansi --no-interaction -f --jobs 3 --no-html-minify --theme Magento/blank en_US nb_NO`
            - execute all generated scd commands
    - save `.static_content_deploy` flag file

> notice: Generate command completed. 

`php ./vendor/bin/ece-tools build:transfer`

> notice: Starting transfer files. 

- [Process\Build\CompressStaticContent](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/CompressStaticContent.php)
    - check `.static_content_deploy` flag file
    - [Util\StaticContentCompressor::process](https://github.com/magento/ece-tools/tree/develop/src/Util/StaticContentCompressor.php)
        - get gzip compression level in `SCD_COMPRESSION_LEVEL` (default: 6 (build stage) or 4 (deploy stage)) from `.magento.env.yaml`
        - get seconds maximum time for running static compression command in `SCD_COMPRESSION_TIMEOUT` (default: 600) from `.magento.env.yaml`
        - get `VERBOSE_COMMANDS` from `.magento.env.yaml`
        - command result: `/usr/bin/timeout -k 30 600 /bin/bash -c 'find '\''/var/magento/pub/static'\'' -type d -name '\''DELETING_*'\'' -prune -o -type f -size +300c '\''('\'' -name '\''*.js'\'' -or -name '\''*.css'\'' -or -name '\''*.svg'\'' -or -name '\''*.html'\'' -or -name '\''*.htm'\'' '\'')'\'' -print0 | xargs -0 -n100 -P16 gzip -q --keep -6'`
- [Process\Build\ClearInitDirectory](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/ClearInitDirectory.php)
    - clear temporary directory: `./init/` 
    - delete `app/etc/env.php` file
- [Process\Build\BackupData](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/BackupData.php)
    - [Process\Build\BackupData\StaticContent](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/BackupData/StaticContent.php)
        - delete `var/.regenerate` flag file
        - check `.static_content_deploy` flag file
        - clear `./init/pub/static/` folder
        - move `pub/static/` to `init/pub/static`
    - [Process\Build\BackupData\WritableDirectories](https://github.com/magento/ece-tools/tree/develop/src/Process/Build/BackupData/WritableDirectories.php)
        - copy `app/etc/` to `init/app/etc/`
        - copy `pub/media/` to `init/pub/media/`
        - copy `var/view_preprocessed/` to `init/var/view_preprocessed/` if `SKIP_HTML_MINIFICATION` = false (Default: true)
        - copy `var/log` to `init/var/log` (e.g. cloud.log file)
    
> notice: Transfer completed. 


**Deploy**
- `php ./vendor/bin/ece-tools deploy`

**Post_deploy**
- `php ./vendor/bin/ece-tools post-deploy`

###### How to extend these scripts and best practices for doing so

###### Describe the ways to retrieve logs for phases and its scripts

#### 5.2 Demonstrate the ability to create Magento Cloud script configurations

Documentation:
- [Deployment process](https://devdocs.magento.com/guides/v2.3/cloud/reference/discover-deploy.html#cloud-deploy-over-phases)
- [Build and deploy / platform.sh](https://docs.platform.sh/configuration/app/build.html#build-hook)
